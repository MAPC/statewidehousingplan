---
title: "01.4_Compare.HeadshipRates"
format: html
editor: visual
---
# 0.0 Setup - Define helper functions, set knitr path, load necessary packages, set muni data keys

# 0.1 - Set knitr path + root for inputs

```{r}
#Use when Rproject is open
#root <- '../../../../Data/Working/Regional_Control_Totals/'

# Base root. Toggle between S: and K: drive depending on mapped paths on your computer
base <- "K:/DataServices/Projects/Current_Projects/"
# base <- "S:/Network Shares/K Drive/DataServices/Projects/Current_Projects/"

#General K drive filepath
root <- paste0(base, "/Housing/StatewideHousingPlan/04_Analysis/Data/Working/Regional_Control_Totals/")

# Reweighter files path
rwt_path <- paste0(base, "Housing/StatewideHousingPlan/04_Analysis/Data/Working/Reweighter/")

#PUMS K drive filepath
pums_path <- paste0(base, "/Housing/StatewideHousingPlan/04_Analysis/Data/Working/PUMS/ipums_2021/")

#Set output filepath
output_path <- paste0(base, "/Housing/StatewideHousingPlan/04_Analysis/Data/Working/PUMS/outputs/")

#Set knitr path
knitr::opts_knit$set(root.dir = pums_path)
```

# 0.2 - Set package dependencies, set environment, set up data keys

```{r}
library(tidyverse)
library(mapcdatakeys)
library(janitor)
library(readxl)
library(here)

# Remove scientific notation
options(scipen = 999)
# Set random seed
set.seed(351)

# Load Libraries for PUMS Analysis and PUMS API query functions
# Sets seed and removes scientific notation
source(here("PUMS_Analysis/PUMS_Helper_Functions.R"))

```

# 1.0 Load in Headship Rate Data
# 1.1 2000 Headship Rates
```{r}
#===============================================================================
# 1.1.1 - 2000 Decennial 5% PUMS Data
# Read in headship rates
headship_rates.2000 <- read_csv(paste0(rwt_path, "Headship_rates/hdsp.r_2000_RPA.AgeCat.HHtype.csv"))

```

# 1.2 Headship Rates from ACS PUMS Data
```{r}
#===============================================================================
#1.2.1 - 
headship_rates.1721 <- read_csv(paste0(rwt_path,"Headship_rates/headship.rates.1721_household.split.csv"))

```

# 1.3 Headship Rates Scenarios
```{r}
#===============================================================================
# 1.3.1 - ACS PUMS 17-21 Split Households (Statewide Housing Plan - Scenario 2)
# Read in headship rates
headship_rates.1721.split <- read_csv(paste0(rwt_path,"Headship_rates/headship.rates.1721_household.split.csv"))

#===============================================================================
```

# 2.0 Compare 1721 PUMS Headship Rates to 1721 PUMS Split Household Headship Rates
```{r}
# Join 2017-2021 5-year ACS PUMS data Headship Rates to the Split Households Headship Rates
hdsp.r_1721.compare.1721.split <- full_join(
  headship_rates.1721,
  headship_rates.1721.split,
  by = c("rpa_acr","ageCAT6","var")
) |> 
  mutate(
    # Fill in Zeros where NAs exist from new headship rate groups being created in the split household tabulation.
    across(starts_with("freq"), ~replace_na(.,0)),
    # Compare differences in headship rates.
    hdsp.r_comp = freq.split-freq
  ) |> 
  filter(
    # Filter for the three household types.
    var %in% c("hhderchild", "hhdernochild", "single")
  )

# Write the 1721 to 1721 Split Headship Rate Comparison file.
write.csv(
  hdsp.r_1721.compare.1721.split,
  paste0(root,"Scenario_2/headship.rates.comparison_1721.hsr_to_1721.household.split.hsr.csv"),
  row.names = FALSE
)

```

# 3.0 Compare 2000 Headship Rates and 1721 Split Headship Rates by RPA, Age Category, and Household Type
```{r}
#===============================================================================
# 6.1 Headship Rate Comparison by RPA, Age Category, and Household Type
# Load in 2000 Headship rates generated by this script (C:/Project_Work/statewidehousingplan/scripts/control_totals/01.1_Generate.2000.HeadshipRates.qmd)
hdsp.r_2000 <- read_csv(paste0(rwt_path,"Headship_rates/hdsp.r_2000_RPA.AgeCat.HHtype.csv")) |> 
  filter(
    # Filter for the three household types.
    var %in% c("hhderchild", "hhdernochild", "single")
  ) |> 
  mutate(
    ageCAT6 = as.factor(ageCAT6)
  )

hdsp.r_1721.split <- headship_rates.split  |> 
  filter(
    # Filter for the three household types.
    var %in% c("hhderchild", "hhdernochild", "single")
  )
  
# Compare Headship Rates from 2000 5% PUMS and Headship Rates from 17-21 ACS 5-year with Split Households by RPA, Age Category, and Household Type
hdshp.r_2000.compare.1721.split <- full_join(
  hdsp.r_2000,
  hdsp.r_1721.split,
  by = c("rpa_acr","ageCAT6","var")
) |> 
  mutate(
    # Fill in Zeros where NAs exist from new headship rate groups being created in the split household tabulation.
    across(starts_with("freq"), ~replace_na(.,0)),
    # When freq.diff is positive, headship rates in 2000 are higher than in the 1721 est.
    # When freq.diff is negative, headship rates in the 1721 est are higher than in 2000.
    freq.diff = freq.2000 - freq.split,
    # Create a flag which tells us which headship rates to use given our strategy for Scenario 2 headship rates:
    # Use 2000 headships rates unless 1721 Split Household headship rates exceed 2000 headship rates.
    use.flag = case_when(
      # Households with householders under the age of 45:
      # .1 Use the Headship rates from the 17-21 ACS w/ Split Households when it is higher than 2000 headship rates.
      ageCAT6 %in% c("1","2","3","4","5","6","7","8","9") & freq.diff < 0 ~ "Use freq.split",
      # .2 Use the Headship rates from the 2000 5% PUMS Sample when it is higher than headship rates from the 17-21 ACS w/ Split Households.
      ageCAT6 %in% c("1","2","3","4","5","6","7","8","9") & freq.diff >= 0 ~ "Use freq.2000",
      # Households with householders 45 and older:
      # .1 Use the Headship rates from the 17-21 ACS w/ Split Households
      ageCAT6 %in% c("10","11","12","13","14","15","16","17","18") ~ "Use freq.split",
      # Default for if the conditional formatting screws up.
      .default = "STOP! Somethings gone awry!"
    ),
    # Create a column with the headship rates to be used in the Scenario 2 Control Totals script.
    freq.scenario2 = case_when(
      use.flag == "Use freq.split" ~ freq.split,
      use.flag == "Use freq.2000" ~ freq.2000,
      .default = 999
    )
  )

# QC Check - Determine if the Scenario 2 headship rate mix remains less than 1.
hr_check <- hdshp.r_2000.compare.1721.split |> 
  group_by(
    rpa_acr,
    ageCAT6
  ) |> 
  summarise(
    freq_check = sum(freq.scenario2)
  ) |> 
  ungroup() |> 
  mutate(
    flag = ifelse(freq_check > 1, 1, 0)
  )

if (sum(hr_check$flag) > 1){
  print("STOP! Check headship rate calculations!")
} else{
  print("Proceed!")
  
  #Remove QC check dataframe
  rm(hr_check)
}

# Write to .csv
write.csv(
  hdshp.r_2000.compare.1721.split,
  paste0(root,"Scenario_2/headship.rates.comparison_2000.hsr_to_1721.household.split.hsr.csv"),
  row.names = FALSE
)

```
