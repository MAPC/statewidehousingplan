---
title: "01_Disability"
format: html
editor: visual
---

# 0.0 Setup - Define helper functions, set knitr path, load necessary packages, set muni data keys

#Set up libraries for the analysis

```{r}
library(tidycensus)
library(tidyverse)
library(survey)
library(srvyr)
library(data.table)
library(janitor) 
library(dplyr)
library(knitr)
library(openxlsx)
library(readxl)
library(writexl)
```

# 0.1 - Set knitr path + root for inputs

```{r}
#copied from MAPC work - not sure if we want to set up this way - ??

#Use when Rproject is open
#root <- '../../../../Data/Working/Regional_Control_Totals/'

#General J drive filepath
root <-"J:/EPPR/Active Studies/EOHLC Statewide Hsg Plan_FY24/Data/pums_UMDI"

#PUMS J drive filepath
pums_path <- "J:/EPPR/Active Studies/EOHLC Statewide Hsg Plan_FY24/Data/pums_UMDI"

#Set output filepath
output_path <- ":/EPPR/Active Studies/EOHLC Statewide Hsg Plan_FY24/Data/pums_UMDI/Output"

#Set knitr path
#knitr::opts_knit$set(root.dir = pums_path)
```

# 0.2 - Set package dependencies, set environment, set up data keys

```{r}
#source("J:/EPPR/Active Studies/EOHLC Statewide Hsg Plan_FY24/Data/pums_UMDI")

#Load PUMS variables
pums <- read.csv("J:/EPPR/Active Studies/EOHLC Statewide Hsg Plan_FY24/Data/pums_UMDI/pums_disab_hh_2021_V_2024-10-02.csv")
```

# 0.3 PUMA to RPA Crosswalk

```{r}
#Load in the municipality to PUMA crosswalk.
RPA_crosswalk <- read.csv ("J:/EPPR/Active Studies/EOHLC Statewide Hsg Plan_FY24/Data/pums_UMDI/PUMA10_RPA_crosswalk.csv")
```

# 0.4 PUMS Data Cleaning

```{r}
#Joining the PUMA to RPA crosswalk to the PUMS data. - not working right now, it's many to many join 
pums <- left_join(
  pums,
  RPA_crosswalk,
  by = c("PUMA"))

pums_duplicates <- pums %>%
    group_by(uniq_obs) %>%
    filter(n() > 1)

print(pums_duplicates)

```

# 1.0 PUMS Analysis

# 1.1 State-level, person level analysis

1)  Number of individuals living outside of GQ with any disability/number living in GQ

2)  Age distribution of people living with disability

```{r}
# 1) Calculate the number of people with a disability

#Create data set with people who have a disability outside of group quarters
people_with_disability <- pums %>%
  group_by(uniq_obs) %>%
  filter(DIS == 1) %>% #filtering for disability flag, will only include person-level data not hhld data
  filter(TYPEHUGQ != 2) #filtering out institutional group quarters

# #Define the survey design
# people_design_dis <- svydesign(ids = ~1,           #No clustering
#                               weights = ~PWGTP,    #Apply person weight
#                               data = people_with_disability)
# 
# #Calculate the total number of people with a disability (weighted)
# total_people_with_disability <- svytotal(~I(uniq_obs != 0), design = people_design_dis)
# print(total_people_with_disability)

#simple way to calculate weighted number of people with disability 
number_of_people_with_disability <- sum(people_with_disability$PWGTP, na.rm = TRUE)

#Calculate the total number of people in sample, not in GQ 
person_data <- pums %>%
filter(RT == "P") %>% #filtering for only people not hhlds 
filter(TYPEHUGQ != 2) 

#add weights for total number in sample
total_weighted_sample <- sum(person_data$PWGTP, na.rm = TRUE)

#Calculate percent with a disability
percentage_with_disability_person <- (number_of_people_with_disability / total_weighted_sample) * 100

dis_summary_table_person <- data.frame(
  "People with Disability" = number_of_people_with_disability,
  "Share with Disability" = percentage_with_disability_person,
  "Total" = total_weighted_sample)


###Repeat above steps for people with disability in GQ


#Create data set with people who have a disability IN group quarters
people_with_disability_GQ <- pums %>%
  group_by(uniq_obs) %>%
  filter(DIS == 1) %>% #filtering disability flag
  filter(TYPEHUGQ == 2) #only institutional group quarters

#simple way to calculate weighted number of people with disability 
number_of_people_with_disability_GQ <- sum(people_with_disability_GQ$PWGTP, na.rm = TRUE)

#Calculate the total number of people in sample in GQ
person_data_GQ <- pums %>%
filter(RT == "P") %>%
filter(TYPEHUGQ == 2)

#add weights
total_weighted_sample_GQ <- sum(person_data_GQ$PWGTP, na.rm = TRUE)

#Calculate percent with a disability
percentage_with_disability_person_GQ <- (number_of_people_with_disability_GQ / total_weighted_sample_GQ) * 100

dis_summary_table_person_GQ <- data.frame(
  "People with Disability" = number_of_people_with_disability_GQ,
  "Share with Disability" = percentage_with_disability_person_GQ,
  "Total" = total_weighted_sample_GQ)

```

12% of people in the state have some type of disability, which is a little over 800,000 people.

This is for the non-institutionalized population and note that children under 5 are not included in the disability measures for cognitive difficulty, ambulatory difficulty, and self-care difficulty. 

In the institutionalized population, 73% have a disability. 


```{r}
# 2) Age distribution of people living with disability
age_people_with_disability <- people_with_disability %>% 
select(uniq_obs, PUMA, PWGTP, AGEP) %>% 
mutate(age_range = case_when(
    AGEP >= 0 & AGEP < 5 ~ "Under 5",
    AGEP >= 5 & AGEP < 18 ~ "5-17",
    AGEP >= 18 & AGEP < 35 ~ "18-34",
    AGEP >= 35 & AGEP < 65 ~ "35-64",
    AGEP >= 65 & AGEP < 75 ~ "65-74",
    AGEP >= 75 ~ "75 and over"))

disability_age_counts <- age_people_with_disability %>%
  group_by(age_range) %>%
  summarise(age_weighted_sum = sum(PWGTP)) %>%
  mutate(percentage = (age_weighted_sum / total_people_with_disability[[2]]) * 100) %>%
  mutate(age_range = factor(age_range, levels = c("Under 5", "5-17", "18-34", "35-64", "65-74", "75 and over"))) %>%
  arrange(age_range)

```

The majority of disabilities are in adults, especially older adults. One in four of people with a disability in the state are age 75 and above. A total of 43% of people with a disability are age 65 and above (17% is 64-74 and 26% is age 75 and above). 

Note that children under 5 are not included in the disability measures for cognitive difficulty, ambulatory difficulty, and self-care difficulty. For the independent living 

```{r}
#Export person-level disability data 
  write.xlsx(list('Percent with disability' = dis_summary_table_person,
                  'Percent of GQ with disability' = dis_summary_table_person_GQ,
                'Age range' = disability_age_counts),
           file = "J:/EPPR/Active Studies/EOHLC Statewide Hsg Plan_FY24/Data/pums_UMDI/Output/dis_person.xlsx") 

```


# 1.2 State-level, household level analysis

Number of hhlds with a member who has a disability statewide and by RPA

Share of hhlds with a member who has a disability statewide and by RPA

Number of hhlds with a member who has a disability by type of disability e.g. With an ambulatory disability, etc.

Share of hhlds with a member who has a disability by type of disability e.g. With an ambulatory disability, etc.

Hhld Income

Housing tenure

Age of housing stock

Over-crowding

Cost-burden

```{r}
#Number of households with a member who has a disability 
#Statewide
#Aggregate person-level data to household level
households_with_disability <- people_with_disability %>%
  group_by(SERIALNO) %>%
  summarize(WGTP = first(WGTP), count_disabled = sum(DIS == 1)) %>%  #Retain household weights (same for all persons in the household)
  ungroup()

#Define the survey design with household weights
household_design_dis <- svydesign(ids = ~1,           #No clustering
                              weights = ~WGTP,    #Apply household weights
                              data = households_with_disability)

#Calculate the total number of households with a disability (weighted)
total_households_with_disability <- svytotal(~I(SERIALNO != 0), design = household_design_dis)
print(total_households_with_disability)

#Calculate the total number of households in sample (weighted)
household_data <- pums %>%
filter(RT == "H")

total_weighted_households <- sum(household_data$WGTP, na.rm = TRUE)
print(total_weighted_sample)

#Calculate percent of households who have some one with a disability
percentage_with_disability <- (total_households_with_disability[[2]] / total_weighted_households[[1]]) * 100

#Create summary table
dis_summary_table <- data.frame(
  "Households with Disability" = total_households_with_disability[[2]],
  "Share of Households with Disability" = percentage_with_disability,
  "Total Households" = total_weighted_households[[1]])

```

22% of households in the state have someone with a disability. This is around 650,000 households. 

```{r}

```

