---
title: "Control Totals"
format: html
editor: visual
---

# 0.0 Setup - Define helper functions, set knitr path, load necessary packages, set muni data keys

#0.1 - Set knitr path + root for inputs
```{r, setup, include=FALSE}
#Use when Rproject is open
#root <- '../../../../Data/Working/Regional_Control_Totals/'

#General K drive filepath
root <-"K:/DataServices/Projects/Current_Projects/Housing/StatewideHousingPlan/04_Analysis/Data/Working/Regional_Control_Totals/"

#Set output filepath
output_path <- "K:/DataServices/Projects/Current_Projects/Housing/StatewideHousingPlan/04_Analysis/Data/Working/Regional_Control_Totals/MAPC/"

#Set knitr path
knitr::opts_knit$set(root.dir = root)
```

# 0.2 - Set package dependencies, set environment, set up data keys
```{r}
library(tidycensus)
library(tidyverse)
library(data.table)
library(reticulate)
library(mapcdatakeys)
library(janitor)
library(readxl)

##get rid of scientific notation
options(scipen = 999)
#Set random seed
set.seed(351)

#Set up muni data keys
#MPO Data Keys
keys.mpo <- mapcdatakeys::all_muni_data_keys |> 
  select(
    muni_id, muni_name, mpo
  ) |> 
  mutate(
    muni_id = as.character(muni_id),
    muni_name = ifelse(muni_name == "Manchester-by-the-Sea", "Manchester", muni_name)
  )

#RPA Data Keys
keys.rpa <- mapcdatakeys::all_muni_data_keys |> 
  select(
    muni_id, muni_name, rpa_acr
  ) |> 
  mutate(
    muni_id = as.character(muni_id),
    muni_name = ifelse(muni_name == "Manchester-by-the-Sea", "Manchester", muni_name)
  )

#Municipal GEOIDs for 2010 Decennial Census
GEOID.10 <- mapcdatakeys::all_muni_data_keys |>  
  select(muni_id, cosub_cn10) |> 
  mutate(
    GEOID = as.character(cosub_cn10)
  ) |> 
  select(GEOID, muni_id)

#Municipal GEOIDs for 2020 Decennial Census
GEOID.20 <- mapcdatakeys::all_muni_data_keys |>  
  select(muni_id, cosub_cn20) |> 
  mutate(
    GEOID = as.character(cosub_cn20)
  ) |> 
  select(GEOID, muni_id)

#County GEOIDs for 2010 Decennial Census
GEOID.cn.10 <- mapcdatakeys::all_muni_data_keys |>  
  mutate(
    GEOID = as.character(str_sub(cosub_cn10, 1, 5))
  ) |> 
  select(county_id, GEOID) |> 
  distinct(
    GEOID,
    .keep_all = TRUE
  )

#County GEOIDs for 2020 Decennial Census
GEOID.cn.20 <- mapcdatakeys::all_muni_data_keys |>  
  mutate(
    GEOID = as.character(str_sub(cosub_cn20, 1, 5))
  ) |> 
  select(county_id, GEOID) |> 
  distinct(
    GEOID,
    .keep_all = TRUE
  )

```

# 0.3 - Define Helper Functions
```{r}
sun <- function(x){
  sort(unique(x))}
lun <- function(x){
  length(unique(x))}
sna <- function(x){
  sort(names(x))}

#Decennial Census API Query Function
#Load 2010 Decennial variables for easier filtering
vars.dec10 <- load_variables(2010, dataset = c("sf1"))

#Load 2020 Decennial variables for easier filtering
vars.dec20 <- load_variables(2020, dataset = c("dhc"))

#decennial_call - Decennial Census Data API Query
#decennial.var_name: list of variables to query the API
#year: vintage of decennial census
decennial_call <- function(decennial.var_name, geog, year){
  if (year == 2010){
    get_decennial(
      variables = decennial.var_name,
      geography = geog, #Specify the level of geography
      state = "MA", #Only evaluating MA municipalities
      year = year, #Set the year in the function call (either 2010 or 2020)
      sumfile = "sf1" #Different summary files depending on year
    )
    
  } else{
    get_decennial(
      variables = decennial.var_name,
      geography = geog, #Specify the level of geography
      state = "MA", #Only evaluating MA municipalities
      year = year, #Set the year in the function call (either 2010 or 2020)
      sumfile = "dhc" #Different summary files depending on year
    )
  }
}

#Decennial Data Cleaning Functions
#dec.vars - loads a list of variables to pass to the decennial census query
#vars: dataframe of all variables in decennial census. pick from vars.dec10 and vars.dec20
#concept: string of the "concept" variable in the vars dataframe
dec.vars <- function(vars, con){
  vars |>  
  filter(concept == con) |> 
  select(name) |> 
  mutate(
    name = as.character(name)
  ) |>  
  pull(name) 
}

#dec.labels - Attaches relevant data labels to data pulled from the decennial census
#by five-year age group
#year: dataframe of all variables in decennial census. pick from vars.dec10 and vars.dec20
#con: string of the "concept" variable in the vars dataframe
dec.labels <- function(year, con){
  if (year == "2010"){
      vars.dec10 |>  
      filter(concept == con) |> #Filter the data to the specific concept
      select(name, label) |>  #Select relevant variables
      filter(str_detect(label, "years")) |> #Removing overhead categories
      #Mutate the text of the label variable to make easier cross-reference to ageCAT6
      #age groups later on in the analysis
      mutate( 
        sex1 = str_extract(label, "Female"),
        sex2 = str_extract(label, "Male"),
        sex = coalesce(sex1,sex2),
        label = gsub("Total!!Male!!","", label),
        label = gsub("Total!!Female!!","", label),
        label = gsub(" ", "_", label),
        label = paste0("pop_", label)
      ) |> 
      #Remove superfluous variables used to coalesce
      select(-c(sex1, sex2)) |>  
      na.omit()
    
  } else{
    vars.dec20 |>  
      filter(concept == con) |> #Filter the data to the specific concept
      select(name, label) |>  #Select relevant variables
      filter(str_detect(label, "years")) |> #Removing overhead categories
      #Mutate the text of the label variable to make easier cross-reference to ageCAT6
      #age groups later on in the analysis
      mutate(
        sex1 = str_extract(label, "Female"),
        sex2 = str_extract(label, "Male"),
        sex = coalesce(sex1,sex2),
        label = gsub("!!Total:!!Male:","", label),
        label = gsub("!!Total:!!Female:","", label),
        label = gsub(" ", "_", label),
        label = sub("!!", "", label),
        label = paste0("pop", label),
      ) |> 
      #Remove superfluous variables used to coalesce
      select(-c(sex1, sex2)) |>  
      na.omit()
    
  }
}

#Group Quarters Cleaning function
gq.clean <- function(df){
    df |> 
    mutate(
      label = str_replace(label,"\\s*\\([^\\)]+\\)",""),
      label = str_replace(label, "Total_!!Male!!",""),
      label = str_replace(label, "Total_!!Female!!",""),
      label = str_replace(label, "Total_:!!Male:!!",""),
      label = str_replace(label, "Total_:!!Female:!!","")
    )
}
```

# 1.0 - Processing UMDI population data

```{r}
# Load in Household Population Projections
umdi_pop <- read_excel(paste0(root, "UMDI/UMDI_V2024_H1_2024.07.19.xlsx"), sheet = 1) |>
  filter(Model == "V2024_H1" & (Year %in% c(2010,2020,2030,2040,2050))) |> 
  #Select years of interest - decadal intervals
  #ageCAT6 refers to 5 year age groups (0-4, 5-9, 10-14, etc.)
  select(MCD,`MCD Code`,`Age Group`,Sex, Year, Population) |> 
  #Rename variables
  dplyr::rename(
    muni_name = MCD,
    muni_id = `MCD Code`,
    ageCAT6 = `Age Group`,
    year = Year,
    pop = Population
  ) |>  
  #Change the data type of both "year" and "pop" variables
  mutate(
    year = as.numeric(year),
    pop = as.numeric(gsub(',','',pop)),
    muni_id = as.character(muni_id),
    ageCAT6 = as.character(ageCAT6)
  )

#RPA Aggregations (MAPC101)
umdi.pop.MAPC101 <- left_join(
  umdi_pop,
  keys.rpa,
  by = c("muni_id", "muni_name")
) |> 
  group_by(
    rpa_acr,
    #Sex,
    ageCAT6,
    year
  ) |> 
  summarise(
    pop = sum(pop)
  ) |> 
  ungroup()

#MPO Aggregations (MAPC97)
umdi.pop.MAPC97 <- left_join(
  umdi_pop,
  keys.mpo,
  by = c("muni_id", "muni_name")
)|> 
  group_by(
    mpo,
    #Sex,
    ageCAT6,
    year
  ) |> 
  summarise(
    pop = sum(pop)
  ) |> 
  ungroup()

#Remove topline umdi population projections
rm(umdi_pop)

```

# Population

```{r}
#===============================================================================
#Decennial 2010 Population
#Creates a list of sex by age population variables to use in the API query
pop.vars <- dec.vars(vars.dec10, "SEX BY AGE")
pop.vars <- data.frame(pop.vars) |> dplyr::slice(1:49) |> pull(pop.vars)

#Assigns appropriate labels to the Decennial Census variables
pop.labels <- dec.labels("2010", "SEX BY AGE") |> slice(1:46)

#Queries the Census API via {tidycensus} to retrieve data about the population
pop.values <- decennial_call(pop.vars, geog = "county subdivision", 2010)

#Clean the Population data.
pop.10 <- pop.values |> 
  filter(GEOID %in% GEOID.10$GEOID) |> 
  right_join(
    pop.labels,
    by = c("variable"="name")
  ) |> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == 'pop_Under_5_years' ~ '1',
      label == "pop_5_to_9_years" ~ '2',
      label == "pop_10_to_14_years" ~ '3',
      label %in% c("pop_15_to_17_years","pop_18_and_19_years") ~ '4',
      label %in% c("pop_20_years","pop_21_years","pop_22_to_24_years") ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label %in% c("pop_60_and_61_years","pop_62_to_64_years") ~ '13',
      label %in% c("pop_65_and_66_years","pop_67_to_69_years") ~ '14',
      label == "pop_70_to_74_years" ~ '15',
      label == "pop_75_to_79_years" ~ '16',
      label == "pop_80_to_84_years" ~ '17',
      label == "pop_85_years_and_over" ~ '18'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.10,
    by = c('GEOID')
  ) |>  
  mutate(
    muni_id = as.character(muni_id)
  ) |> 
  dplyr::rename(
    Population = value,
    Sex = sex
  ) |>  
  select(muni_id, Sex, ageCAT6, Population) |>  
  group_by(
    muni_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    Population = sum(Population)
  ) |>  
  ungroup()

#Remove dataframes no longer needed in the process.
rm(pop.labels, pop.values, pop.vars)

#===============================================================================
#Decennial 2020 Population
#Creates a list of sex by age population variables to use in the API query
pop.vars <- dec.vars(vars.dec20, "SEX BY AGE FOR SELECTED AGE CATEGORIES")

#Assigns appropriate labels to the Decennial Census variables
pop.labels <- dec.labels("2020", "SEX BY AGE FOR SELECTED AGE CATEGORIES")

#Queries the Census API via {tidycensus} to retrieve data about the population
pop.values <- decennial_call(pop.vars, geog = "county subdivision", 2020)

#Clean the Population data.
pop.20 <- pop.values |> 
  filter(GEOID %in% GEOID.20$GEOID) |> 
  right_join(
    pop.labels,
    by = c("variable"="name")
  ) |> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == 'pop_Under_5_years' ~ '1',
      label == "pop_5_to_9_years" ~ '2',
      label == "pop_10_to_14_years" ~ '3',
      label %in% c("pop_15_to_17_years","pop_18_and_19_years") ~ '4',
      label %in% c("pop_20_years","pop_21_years","pop_22_to_24_years") ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label %in% c("pop_60_and_61_years","pop_62_to_64_years") ~ '13',
      label %in% c("pop_65_and_66_years","pop_67_to_69_years") ~ '14',
      label == "pop_70_to_74_years" ~ '15',
      label == "pop_75_to_79_years" ~ '16',
      label == "pop_80_to_84_years" ~ '17',
      label == "pop_85_years_and_over" ~ '18'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.20,
    by = c('GEOID')
  ) |>  
  mutate(
    muni_id = as.character(muni_id)
  ) |> 
  dplyr::rename(
    Population = value,
    Sex = sex
  ) |>  
  select(muni_id, Sex, ageCAT6, Population) |>  
  group_by(
    muni_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    Population = sum(Population)
  ) |>  
  ungroup()

#Remove dataframes no longer needed in the process.
rm(pop.labels, pop.values, pop.vars)
gc()
```
# Query Census Household Population data for 2010 and 2020
# Determine General Household Formation Rate (% of population in households)

```{r}
#===============================================================================
#Decennial 2010 Population in Households
#Creates a list of sex by age population variables to use in the API query
pa.vars <- dec.vars(vars.dec10, "SEX BY AGE FOR THE POPULATION IN HOUSEHOLDS")

#Assigns appropriate labels to the Decennial Census variables
pa.labels <- dec.labels("2010", "SEX BY AGE FOR THE POPULATION IN HOUSEHOLDS")

#Queries the Census API via {tidycensus} to retrieve data about the population
#in households
pa.values <- decennial_call(pa.vars, geog = "county subdivision", 2010)

#Clean the Household Population data.
hhpop.10 <- pa.values |> 
  filter(GEOID %in% GEOID.10$GEOID) |> 
  right_join(
    pa.labels,
    by = c("variable"="name")
  ) |> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == 'pop_Under_5_years' ~ '1',
      label == "pop_5_to_9_years" ~ '2',
      label == "pop_10_to_14_years" ~ '3',
      label %in% c("pop_15_to_17_years","pop_18_and_19_years") ~ '4',
      label %in% c("pop_20_years","pop_21_years","pop_22_to_24_years") ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label %in% c("pop_60_and_61_years","pop_62_to_64_years") ~ '13',
      label %in% c("pop_65_and_66_years","pop_67_to_69_years") ~ '14',
      label == "pop_70_to_74_years" ~ '15',
      label == "pop_75_to_79_years" ~ '16',
      label == "pop_80_to_84_years" ~ '17',
      label == "pop_85_years_and_over" ~ '18'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.10,
    by = c('GEOID')
  ) |>  
  mutate(
    muni_id = as.character(muni_id)
  ) |> 
  dplyr::rename(
    HHPopulation = value,
    Sex = sex
  ) |>  
  select(muni_id, Sex, ageCAT6, HHPopulation) |>  
  group_by(
    muni_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    HHPopulation = sum(HHPopulation)
  ) |>  
  ungroup()

#Remove dataframes no longer needed in the process.
rm(pa.labels, pa.values, pa.vars)

#===============================================================================
#Decennial 2020 Population in Households
#Creates a list of sex by age population variables to use in the API query
pa.vars <- dec.vars(vars.dec20, "SEX BY AGE FOR THE POPULATION IN HOUSEHOLDS")

#Assigns appropriate labels to the Decennial Census variables
pa.labels <- dec.labels("2020", "SEX BY AGE FOR THE POPULATION IN HOUSEHOLDS")

#Queries the Census API via {tidycensus} to retrieve data about the population
#in households
pa.values <- decennial_call(pa.vars, geog = "county subdivision", 2020)

#Clean the 2020 Household Population data
hhpop.20 <- pa.values |> 
  filter(GEOID %in% GEOID.20$GEOID) |> 
  right_join(
    pa.labels,
    by = c("variable"="name")
  ) |> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == 'pop_Under_5_years' ~ '1',
      label == "pop_5_to_9_years" ~ '2',
      label == "pop_10_to_14_years" ~ '3',
      label %in% c("pop_15_to_17_years","pop_18_and_19_years") ~ '4',
      label %in% c("pop_20_years","pop_21_years","pop_22_to_24_years") ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label %in% c("pop_60_and_61_years","pop_62_to_64_years") ~ '13',
      label %in% c("pop_65_and_66_years","pop_67_to_69_years") ~ '14',
      label == "pop_70_to_74_years" ~ '15',
      label == "pop_75_to_79_years" ~ '16',
      label == "pop_80_to_84_years" ~ '17',
      label == "pop_85_years_and_over" ~ '18'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.20,
    by = c('GEOID')
  ) |>  
  mutate(
    muni_id = as.character(muni_id)
  ) |> 
  dplyr::rename(
    HHPopulation = value,
    Sex = sex
  ) |>  
  select(muni_id, Sex, ageCAT6, HHPopulation) |>  
  group_by(
    muni_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    HHPopulation = sum(HHPopulation)
  ) |>  
  ungroup()

#Remove dataframes no longer needed in the process.
rm(pa.labels, pa.values, pa.vars)
gc()
```
# Join 2010 and 2020 Population and Household Population data 
```{r}
#Join Census Population and Household Population 
population.df <- purrr::reduce(
  list(pop.10, pop.20, hhpop.10,hhpop.20),
  dplyr::left_join, by = c("muni_id", "Sex", "ageCAT6")
  ) |> 
  dplyr::rename(
    Population.10 = Population.x,
    Population.20 = Population.y,
    HHPopulation.10 = HHPopulation.x,
    HHPopulation.20 = HHPopulation.y
  ) |> 
  rowwise() |> 
  #Calculate Group Quarters population using Census Pop and HHpop data.
  mutate(
    GQPopulation.10 = Population.10 - HHPopulation.10,
    GQPopulation.20 = Population.20 - HHPopulation.20
  )

```

# Group Quarters Population - Total
```{r}
#===============================================================================
#Group Quarters Population 2010
#Creates a list of sex by age group quarters population variables to use in the API query
gq.vars <- dec.vars(vars.dec10, "GROUP QUARTERS POPULATION BY SEX BY AGE")

#Assigns appropriate labels to the Decennial Census variables
gq.labels <- dec.labels("2010", "GROUP QUARTERS POPULATION BY SEX BY AGE") |> gq.clean()

#Queries the Census API via {tidycensus} to retrieve data about the group 
#quarters population
gq.values <- decennial_call(gq.vars, geog = "county", 2010)

#Clean the 2010 Group Quarters Population data
gqpop.10 <- gq.values |> 
  filter(GEOID %in% GEOID.cn.10$GEOID) |> 
  right_join(
    gq.labels,
    by = c("variable" = "name")
  )|> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == 'pop_Under_5_years' ~ '1',
      label == "pop_5_to_9_years" ~ '2',
      label == "pop_10_to_14_years" ~ '3',
      label == "pop_15_to_19_years" ~ '4',
      label == "pop_20_to_24_years" ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label == "pop_60_to_64_years" ~ '13',
      label == "pop_65_to_69_years" ~ '14',
      label == "pop_70_to_74_years" ~ '15',
      label == "pop_75_to_79_years" ~ '16',
      label == "pop_80_to_84_years" ~ '17',
      label == "pop_85_years_and_over" ~ '18'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.cn.10,
    by = c('GEOID')
  ) |>  
  mutate(
    county_id = as.character(county_id)
  ) |> 
  dplyr::rename(
    GQPopulation = value,
    Sex = sex
  ) |>  
  select(county_id, Sex, ageCAT6, GQPopulation) |>  
  group_by(
    county_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    GQPopulation = sum(GQPopulation)
  ) |>  
  ungroup()
  
#Remove dataframes no longer needed in the process.
rm(gq.labels, gq.values, gq.vars)

#===============================================================================
#Group Quarters Population 2020
#Creates a list of sex by age group quarters population variables to use in the API query
gq.vars <- dec.vars(vars.dec20, "GROUP QUARTERS POPULATION BY SEX BY AGE")

#Assigns appropriate labels to the Decennial Census variables
gq.labels <- dec.labels("2020", "GROUP QUARTERS POPULATION BY SEX BY AGE") |> gq.clean()

#Queries the Census API via {tidycensus} to retrieve data about the group 
#quarters population
gq.values <- decennial_call(gq.vars, geog = "county", 2020)

#Clean the 2020 Group Quarters Population data
gqpop.20 <- gq.values |> 
  filter(GEOID %in% GEOID.cn.20$GEOID) |> 
  right_join(
    gq.labels,
    by = c("variable" = "name")
  )|> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == 'pop_Under_5_years' ~ '1',
      label == "pop_5_to_9_years" ~ '2',
      label == "pop_10_to_14_years" ~ '3',
      label == "pop_15_to_19_years" ~ '4',
      label == "pop_20_to_24_years" ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label == "pop_60_to_64_years" ~ '13',
      label == "pop_65_to_69_years" ~ '14',
      label == "pop_70_to_74_years" ~ '15',
      label == "pop_75_to_79_years" ~ '16',
      label == "pop_80_to_84_years" ~ '17',
      label == "pop_85_years_and_over" ~ '18'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.cn.20,
    by = c('GEOID')
  ) |>  
  mutate(
    county_id = as.character(county_id)
  ) |> 
  dplyr::rename(
    GQPopulation = value,
    Sex = sex
  ) |>  
  select(county_id, Sex, ageCAT6, GQPopulation) |>  
  group_by(
    county_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    GQPopulation = sum(GQPopulation)
  ) |>  
  ungroup()

#Remove dataframes no longer needed in the process.
rm(gq.labels, gq.values, gq.vars)
gc()
```

# Group Quarters Population - University/College Students
```{r}
#===============================================================================
#Group Quarters Population - College and University Student Housing 2020
#Creates a list of sex by age group quarters population variables to use in the API query
gq.vars <- dec.vars(vars.dec10, "GROUP QUARTERS POPULATION IN COLLEGE/UNIVERSITY STUDENT HOUSING BY SEX BY AGE")

#Assigns appropriate labels to the Decennial Census variables
gq.labels <- dec.labels("2010", "GROUP QUARTERS POPULATION IN COLLEGE/UNIVERSITY STUDENT HOUSING BY SEX BY AGE") |> gq.clean()

#Queries the Census API via {tidycensus} to retrieve data about the group 
#quarters population in college or university housing
gq.values <- decennial_call(gq.vars, geog = "county", 2010)

#Clean the 2020 Group Quarters Population data
cu.gqpop.10 <- gq.values |> 
  filter(GEOID %in% GEOID.cn.10$GEOID) |> 
  right_join(
    gq.labels,
    by = c("variable" = "name")
  )|> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == 'pop_Under_5_years' ~ '1',
      label == "pop_5_to_9_years" ~ '2',
      label == "pop_10_to_14_years" ~ '3',
      label == "pop_15_to_19_years" ~ '4',
      label == "pop_20_to_24_years" ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label == "pop_60_to_64_years" ~ '13',
      label == "pop_65_to_69_years" ~ '14',
      label == "pop_70_to_74_years" ~ '15',
      label == "pop_75_to_79_years" ~ '16',
      label == "pop_80_to_84_years" ~ '17',
      label == "pop_85_years_and_over" ~ '18'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.cn.10,
    by = c('GEOID')
  ) |>  
  mutate(
    county_id = as.character(county_id)
  ) |> 
  dplyr::rename(
    CU.GQPopulation = value,
    Sex = sex
  ) |>  
  select(county_id, Sex, ageCAT6, CU.GQPopulation) |>  
  group_by(
    county_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    CU.GQPopulation = sum(CU.GQPopulation)
  ) |>  
  ungroup()

#Remove dataframes no longer needed in the process.
rm(gq.labels, gq.values, gq.vars)

#===============================================================================
#Group Quarters Population - College and University Student Housing 2020
#Creates a list of sex by age group quarters population variables to use in the API query
gq.vars <- dec.vars(vars.dec20, "GROUP QUARTERS POPULATION IN COLLEGE/UNIVERSITY STUDENT HOUSING BY SEX BY AGE")

#Assigns appropriate labels to the Decennial Census variables
gq.labels <- dec.labels("2020", "GROUP QUARTERS POPULATION IN COLLEGE/UNIVERSITY STUDENT HOUSING BY SEX BY AGE") |> gq.clean()

#Queries the Census API via {tidycensus} to retrieve data about the group 
#quarters population in college or university housing
gq.values <- decennial_call(gq.vars, geog = "county", 2020)

#Clean the 2020 Group Quarters Population data
cu.gqpop.20 <- gq.values |> 
  filter(GEOID %in% GEOID.cn.20$GEOID) |> 
  right_join(
    gq.labels,
    by = c("variable" = "name")
  )|> 
  #Change the Census age category levels to match the ageCAT6 labels
  mutate(
    ageCAT6 = case_when(
      label == "pop_Under_20_years" ~ '4',
      label == "pop_20_to_24_years" ~ '5',
      label == "pop_25_to_29_years" ~ '6',
      label == "pop_30_to_34_years" ~ '7',
      label == "pop_35_to_39_years" ~ '8',
      label == "pop_40_to_44_years" ~ '9',
      label == "pop_45_to_49_years" ~ '10',
      label == "pop_50_to_54_years" ~ '11',
      label == "pop_55_to_59_years" ~ '12',
      label == "pop_60_to_64_years" ~ '13',
      label == "pop_65_and_over" ~ '14'
    )
  ) |> 
  filter(!is.na(ageCAT6)) |>  
  right_join(
    GEOID.cn.20,
    by = c('GEOID')
  ) |>  
  mutate(
    county_id = as.character(county_id)
  ) |> 
  dplyr::rename(
    CU.GQPopulation = value,
    Sex = sex
  ) |>  
  select(county_id, Sex, ageCAT6, CU.GQPopulation) |>  
  group_by(
    county_id,
    Sex,
    ageCAT6
  ) |> 
  summarise(
    CU.GQPopulation = sum(CU.GQPopulation)
  ) |>  
  ungroup()

#Remove dataframes no longer needed in the process.
rm(gq.labels, gq.values, gq.vars)
gc()
```

# Calculate the percentage of the group quarters population living in 
# Univerity/College Housing 

```{r}
#Join the total GQ Population and University/College GQ Population
gqpop.df <- purrr::reduce(
  list(gqpop.10, gqpop.20, cu.gqpop.10, cu.gqpop.20),
  dplyr::left_join, by = c("county_id", "Sex", "ageCAT6")
  ) |> 
  mutate(across(everything(), ~ replace_na(., 0))) |> 
  #Rename variables
  dplyr::rename(
    GQPopulation.10 = GQPopulation.x,
    GQPopulation.20 = GQPopulation.y,
    CU.GQPopulation.10 = CU.GQPopulation.x,
    CU.GQPopulation.20 = CU.GQPopulation.y
  ) |> 
  rowwise() |> 
  #Calculate the proportion of the gqpopulation living in university or college
  #housing by age and sex for both 2010 and 2020
  mutate(
    pct_CU.GQPopulation.10 = CU.GQPopulation.10/GQPopulation.10,
    pct_CU.GQPopulation.20 = CU.GQPopulation.20/GQPopulation.20
  )

#Remove intermediate dataframes
rm(cu.gqpop.10, cu.gqpop.20)
gc()
```

# QC Check - Compare the calculated GQ Population to the GQ Population at the county
# Level (by age by sex)
```{r}
#Create a municipality to county crosswalk with {mapcdatakeys}
muni_county.xw <- mapcdatakeys::all_muni_data_keys |> 
  select(muni_id,muni_name,county_id,county) |> 
  #Make all variables characters
  mutate(across(everything(), ~as.character(.)))

#Join the municipal level population data to the county to muni crosswalk
qc.population.df <- left_join(
  population.df,
  muni_county.xw,
  by = c("muni_id")
) |> 
  group_by(
    county_id,
    Sex,
    ageCAT6
  ) |> 
  #Aggregate municipal level calculated group quarters to the county level
  summarise(
    calc.GQPopulation.10 = sum(GQPopulation.10),
    calc.GQPopulation.20 = sum(GQPopulation.20)
  ) |> 
  ungroup()

#Join gq population calculated in from the population - household population data
#aggregated to county level to the gq population data pulled directly from the Census
qc.population.df <- purrr::reduce(
  list(qc.population.df, gqpop.10, gqpop.20),
  dplyr::left_join, by = c("county_id", "Sex", "ageCAT6")
) |> 
  dplyr::rename(
    GQPopulation.10 = GQPopulation.x,
    GQPopulation.20 = GQPopulation.y,
  ) |> 
  #Calculate the difference between the calculated gq population and the available gq population
  mutate(
    gq.check.10 = calc.GQPopulation.10 - GQPopulation.10,
    gq.check.20 = calc.GQPopulation.20 - GQPopulation.20
  )

#Print terms to automatically tell the user if they have passed the QC check.
if (sum(qc.population.df$gq.check.10 > 0)){
  print("STOP! Please check 2010 Census data queries and Group Quarters population calculations.")
} else{
  print("PROCEED!")
}

if(sum(qc.population.df$gq.check.20 > 0)){
  print("STOP! Please check 2020 Census data queries and Group Quarters population calculations.")
} else{
  print("PROCEED!")
  
  #Remove unneeded dataframes
  rm(qc.population.df, muni_county.xw, gqpop.10, gqpop.20, gqpop.df, hhpop.10, hhpop.20,
     pop.10, pop.20)
}

```

# QC Check - Compare Census Population by Age by Sex to Projected Population data
```{r}
#Projections 
proj.pop.10 <- umdi.pop.MAPC101 |> 
  filter(year == 2010) |> 
  mutate(
    muni_id = as.character(muni_id),
    ageCAT6 = as.character(ageCAT6)
  ) |> 
  select(
    muni_id,
    Sex,
    ageCAT6,
    pop
  )

proj.pop.20 <- umdi.pop.MAPC101 |> 
  filter(year == 2020) |> 
  mutate(
    muni_id = as.character(muni_id),
    ageCAT6 = as.character(ageCAT6)
  ) |> 
  select(
    muni_id,
    Sex,
    ageCAT6,
    pop
  )

#Census
pop.10 <- population.df |> 
  select(
    muni_id,
    Sex,
    ageCAT6,
    Population.10
  )
  
pop.20 <- population.df |> 
  select(
    muni_id,
    Sex,
    ageCAT6,
    Population.20
  )

#QC Check - 2010 Population
qc.population.10 <- left_join(
  pop.10,
  proj.pop.10,
  by = c("muni_id", "Sex", "ageCAT6")
) |> 
  mutate(
    qc.check = Population.10 - pop
  )

#Print terms to automatically tell the user if they have passed the QC check.
if (sum(qc.population.10$qc.check > 0)){
  print("STOP! Please check 2010 Census data queries and UMDI Population Projections data.")
} else{
  print("PROCEED!")
  
  #Remove QC dataframes
  rm(qc.population.10, pop.10, proj.pop.10)
}

#QC Check - 2020 Population
qc.population.20 <- left_join(
  pop.20,
  proj.pop.20,
  by = c("muni_id", "Sex", "ageCAT6")
) |> 
  mutate(
    qc.check = Population.20 - pop
  )

#Print terms to automatically tell the user if they have passed the QC check
if(sum(qc.population.20$qc.check > 0)){
  print("STOP! Please check 2020 Census data queries and UMDI Population Projections data.")
} else{
  print("PROCEED!")
  
  #Remove QC dataframes
  rm(qc.population.20, pop.20, proj.pop.20)
}

```

# Calculate the Percentage of People in Households by RPA and MPO
```{r}
#===============================================================================
#Calculating MAPC101 Population in Households Rate by RPA, Sex, Age Category
population.MAPC101.df <- population.df |> 
  left_join(
    keys.rpa,
    by = c("muni_id")
  ) |> 
  group_by(
    rpa_acr,
    #Sex,
    ageCAT6
  ) |> 
  summarise(
    Population.10 = sum(Population.10),
    Population.20 = sum(Population.20),
    HHPopulation.10 = sum(HHPopulation.10),
    HHPopulation.20 = sum(HHPopulation.20),
    GQPopulation.10 = sum(GQPopulation.10),
    GQPopulation.20 = sum(GQPopulation.20)
  ) |> 
  ungroup() |> 
  rowwise() |> 
  mutate(
    pct_pop.in.hhd.10 = HHPopulation.10/Population.10,
    pct_pop.in.hhd.20 = HHPopulation.20/Population.20
  ) |> 
  select(
    rpa_acr,
    #Sex,
    ageCAT6,
    GQPopulation.10,
    GQPopulation.20,
    pct_pop.in.hhd.10,
    pct_pop.in.hhd.20
  )

write.csv(
  population.MAPC101.df,
  paste0(output_path,"pct_pop.in.hhds.MAPC101_by.RPA.ageCAT6.csv"),
  row.names = FALSE
)

#Calculating MAPC97 Population in Households Rate by RPA, Sex, Age Category
population.MAPC97.df <- population.df |> 
  left_join(
    keys.mpo,
    by = c("muni_id")
  ) |> 
  group_by(
    mpo,
    #Sex,
    ageCAT6
  ) |> 
  summarise(
    Population.10 = sum(Population.10),
    Population.20 = sum(Population.20),
    HHPopulation.10 = sum(HHPopulation.10),
    HHPopulation.20 = sum(HHPopulation.20),
    GQPopulation.10 = sum(GQPopulation.10),
    GQPopulation.20 = sum(GQPopulation.20)
  ) |> 
  ungroup() |> 
  rowwise() |> 
  mutate(
    pct_pop.in.hhd.10 = HHPopulation.10/Population.10,
    pct_pop.in.hhd.20 = HHPopulation.20/Population.20
  ) |> 
  select(
    mpo,
    #Sex,
    ageCAT6,
    GQPopulation.10,
    GQPopulation.20,
    pct_pop.in.hhd.10,
    pct_pop.in.hhd.20
  )

write.csv(
  population.MAPC97.df,
  paste0(output_path,"pct_pop.in.hhds.MAPC97_by.MPO.ageCAT6.csv"),
  row.names = FALSE
)

#===============================================================================
#MAPC101
umdi.pop.MAPC101 <- left_join(
  umdi.pop.MAPC101,
  population.MAPC101.df,
  by = c("rpa_acr","ageCAT6")
) |> 
  mutate(
    hhpop = case_when(
      year == 2010 & ageCAT6 == "1" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "2" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "3" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "4" ~ pop - GQPopulation.10,
      year == 2010 & ageCAT6 == "5" ~ pop - GQPopulation.10,
      year == 2010 & ageCAT6 == "6" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "7" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "8" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "9" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "10" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "11" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "12" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "13" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "14" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "15" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "16" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "17" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "18" ~ pop*pct_pop.in.hhd.10,
      year != 2010 & ageCAT6 == "1" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "2" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "3" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "4" ~ pop - GQPopulation.20,
      year != 2010 & ageCAT6 == "5" ~ pop - GQPopulation.20,
      year != 2010 & ageCAT6 == "6" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "7" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "8" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "9" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "10" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "11" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "12" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "13" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "14" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "15" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "16" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "17" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "18" ~ pop*pct_pop.in.hhd.20,
    ),
    #Round the Household Population to the nearest whole number (person).
    hhpop = round(hhpop, 0)
  ) |> 
  select(
    -c(
      GQPopulation.10,
      GQPopulation.20,
      pct_pop.in.hhd.10,
      pct_pop.in.hhd.20
    )
  )

#MAPC97
umdi.pop.MAPC97 <- left_join(
  umdi.pop.MAPC97,
  population.MAPC97.df,
  by = c("mpo","ageCAT6")
) |> 
  mutate(
    hhpop = case_when(
      year == 2010 & ageCAT6 == "1" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "2" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "3" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "4" ~ pop - GQPopulation.10,
      year == 2010 & ageCAT6 == "5" ~ pop - GQPopulation.10,
      year == 2010 & ageCAT6 == "6" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "7" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "8" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "9" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "10" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "11" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "12" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "13" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "14" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "15" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "16" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "17" ~ pop*pct_pop.in.hhd.10,
      year == 2010 & ageCAT6 == "18" ~ pop*pct_pop.in.hhd.10,
      year != 2010 & ageCAT6 == "1" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "2" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "3" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "4" ~ pop - GQPopulation.20,
      year != 2010 & ageCAT6 == "5" ~ pop - GQPopulation.20,
      year != 2010 & ageCAT6 == "6" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "7" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "8" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "9" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "10" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "11" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "12" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "13" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "14" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "15" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "16" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "17" ~ pop*pct_pop.in.hhd.20,
      year != 2010 & ageCAT6 == "18" ~ pop*pct_pop.in.hhd.20,
    ),
    #Round the Household Population to the nearest whole number (person).
    hhpop = round(hhpop, 0)
  ) |> 
  select(
    -c(
      GQPopulation.10,
      GQPopulation.20,
      pct_pop.in.hhd.10,
      pct_pop.in.hhd.20
    )
  )

#Removing dataframes no longer necessary for the creation of reweighter targets.
rm(population.MAPC101.df, population.MAPC97.df, population.df, GEOID.cn.10, GEOID.cn.20,
   vars.dec10, vars.dec20)
gc()

```


#2.0 - Load and process PUMS Data

```{r}
#Set PUMS vintage final year for {tidycensus} API query.
yr <- 2021

#Set up datakeys for future joins.
mkeys <- mapcdatakeys::all_muni_data_keys |>  select(muni_id,rpa_acr,mpo)

#Load in the municipality to PUMA crosswalk.
psf <- fread(paste0(root,'ma_muni_puma10_join.csv')) |>
  dplyr::rename(
    muni_id=TOWN_ID,
    PUMA = PUMACE10
  ) |>
  left_join(
    mkeys,
    by = c('muni_id')
  ) |>
  setDT()

#Generate RPA to PUMA crosswalk.
lsf <- psf[,lapply(.SD,sum,na.rm=T),.(rpa_acr,PUMA),.SDcols='Shape_Area']
lsf[,mx:=max(Shape_Area),PUMA]
xw <- lsf[Shape_Area==mx, .(rpa_acr,PUMA)]
xw[,PUMA:=sprintf("%05d",PUMA)]

#Manufacturing MVC and NPEDC RPAs manually
matrix <- matrix(nrow = 1, ncol = 2)
col_names <- c("rpa_acr", "PUMA")

mvc <- data.frame(matrix = matrix)
npedc <- data.frame(matrix = matrix)
colnames(mvc) <- col_names
colnames(npedc) <- col_names
mvc[[1]] <- "MVC"
mvc[[2]] <- "04800"
npedc[[1]] <- "NPEDC"
npedc[[2]] <- "04800"

xw <- bind_rows(xw, mvc, npedc)

rm(matrix, col_names, mvc, npedc)

#List of all 2017-2021 ACS PUMS Variables
allvars <- pums_variables |>  filter(year==yr) |>  select(var_code) |>  unique()

#List of PUMS variables
variable_list <- c("PUMA", "TYPEHUGQ", "SEX", "AGEP", "RAC1P", "HISP", "ESR",
                   "WKHP", "SCHL", "WAGP", "SEMP", "ADJINC", "SPORDER", "HINCP")
#SEMP bottom coding has changed from $1 to $4 like WAGP

#Query {tidycensus} for 2017-2021 5-Year PUMS data
pums_data <- get_pums(
    state = "MA",
    survey = "acs5",
    year = yr,
    variables = variable_list
  ) |> 
  #Join RPA to PUMA crosswalk to PUMS data
  left_join(
    xw,
    by = c('PUMA')
  ) |>  
  mutate(
    #Generate five-year age groupings to match UMDI population projections data.
    ageCAT6 = cut(AGEP, breaks = c(-Inf, seq(4, 84, 5), Inf), labels = 1:18),
    # Consolidated Age Category
    # NOTE: Levels are (0) 0-14; (4) 15 to 19; (5) 20 to 24; (6) 25 to 34; (7) 35 to 44; (8) 45 to 54; (9) 55 to 64 (10) 65 to 74 (11) 75+
    PAGEC2 = cut(AGEP, breaks = c(-Inf, 14, 19, 24, 34, 44, 54, 64, 74, 79, 84, Inf),
                 labels = c(0, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13)),
    # Categorizing employment status
    empstat = case_when(
      ESR == "b" ~ "Under 16 not eligible for work",
      ESR == 1 ~ "Employed",
      ESR == 2 ~ "Employed but not at work",
      ESR == 3 ~ "Unemployed",
      ESR == 4 ~ "Armed forces",
      ESR == 5 ~ "Armed forces but not at work",
      ESR == 6 ~ "Not in labor force"
    ),
    
    # Categorizing Civilian Labor Force or not
    # NOTE: Categories are (0) under 16 or non-civilian, (1) in labor force, (2) not in labor force
    lf = case_when(
      ESR == "b" | ESR == 4 | ESR == 5  ~ 0,
      ESR == 1 | ESR == 2 | ESR == 3  ~ 1,
      ESR == 6 ~ 2,
      is.na(ESR) ~ 0
    ),
    
    # Counts as Worker
    # NOTE: Categories are (0) under 16 or not in labor force, or (1) in labor force or non-civilian worker
    worker = case_when(
      (ESR == "b" | ESR == 6) ~ 0,
      (ESR == 1 | ESR == 2 | ESR == 3 | ESR == 4 | ESR == 5) ~ 1,
      is.na(ESR) ~ 0
    ),
    
    # Categorizing full or part-time work
    wrkfull = case_when(
      WKHP < 35 ~ "Part time (less than 35 hrs)",
      WKHP >= 35 ~ "Full time (35 hrs or more)",
      is.na(WKHP) ~ "Under 16, unemployed, or not in labor force"
    ),
    
    # Categorizing educational attainment
    # NOTE: Categories are (1) High school degree or less, (2) Associate's degree or some college, (3) Bachelor's, and (4) MA or higher
    SCHL = as.numeric(SCHL),
    eduattn = case_when(
      SCHL <= 17 ~ 1,
      SCHL %in% 18:20 ~ 2,
      SCHL == 21 ~ 3,
      SCHL >= 22 ~ 4,
      is.na(SCHL) ~ 0
    ),
    
    # Determine if person is head of household
    HousHder = case_when(
      SPORDER == 1 ~ 1,
      SPORDER > 1 ~ 2
      ),
    
    # Determine if case counts as person
    person = case_when(
      SPORDER != 0 ~ 1,
      SPORDER == 0 ~ 0
      ),
    
    # Determine if case counts as child
    child = case_when(
      AGEP < 18 ~ 1,
      AGEP >= 18 ~ 0
      )
  ) |> 
  
  #Generating Household Variables
  group_by(SERIALNO) |> 
  mutate(
    Worker_Total = sum(worker),
    Person_Total = sum(person),
    Child_Total = sum(child)
  ) |> 
  ungroup() |> 
  # Categorizing household sizes by number of persons (1) one person, (2) two persons, (3) three persons, (4) four or more persons
  mutate(
    HHSize = case_when(
      Person_Total == 1 ~ 1,
      Person_Total == 2 ~ 2,
      Person_Total == 3 ~ 3,
      Person_Total >= 4 ~ 4
    ),
    
    # Categorizing worker categories (0) no workers, (1) one worker, (2) two workers, (3) three or more workers
    WRKHH = case_when(
      Worker_Total == 0 ~ 0,
      Worker_Total == 1 ~ 1,
      Worker_Total == 2 ~ 2,
      Worker_Total >= 3 ~ 3
      ),
    
    # Determine if person is not hhder vs hhder of 0- wrk, 1wrk, 2 wrk, 3+wrk
    HHder = case_when(
      SPORDER == 1 & WRKHH == 0 ~ 0,
      SPORDER == 1 & WRKHH == 1 ~ 1,
      SPORDER == 1 & WRKHH == 2 ~ 2,
      SPORDER == 1 & WRKHH == 3 ~ 3,
      SPORDER > 1 ~ 99
    ),
    # Determine what type of household the person is heading or not heading (1) head child, (2) child, (3) head not child, (4) not head no child, (5) head single
    HHtype = case_when(
      Child_Total >= 1 & Person_Total > 1 & HHder != 99 ~ 1,
      Child_Total >= 1 & Person_Total > 1 & HHder == 99 ~ 2,
      Child_Total == 0 & Person_Total > 1 & HHder != 99 ~ 3,
      Child_Total == 0 & Person_Total > 1 & HHder == 99 ~ 4,
      Person_Total == 1 & HHder != 99 ~ 5
    )
  )

#Check to make sure all RPAs have been included in the PUMA-RPA Crosswalk.
if (length(unique(pums_data$rpa_acr)) != 13){
  print("STOP! Check the PUMA - RPA Crosswalk for MVC and NPEDC.")
} else{
  print("Proceed!")
}

```

# Generating reweighter target files
# x.1 - Generate the ACS 2017-2021 PUMS Baseline data for each of our categories

```{r}
#===============================================================================
# x.1 - Generate BASELINE data for the reweighter targeting files
# x.1.1 -Baseline of people in Households
hhpop_baseline <- pums_data |>  
  filter(TYPEHUGQ == "1") |>  
  mutate(
    ageCAT6 = as.factor(ageCAT6),
    RPA = as.factor(rpa_acr)
  ) |> 
  group_by(
    RPA
  ) |>  
  dplyr::count(
    var = ageCAT6,
    wt = PWGTP
  ) |>  
  dplyr::rename(
    AgeCat = var,
    BASELINE = n
  ) |>  
  mutate(
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
   ),
   INTER = BASELINE
  )

# x.1.2 - Baseline of Households by Household Type
hhtype_baseline <- pums_data |>  
  filter(TYPEHUGQ == "1" & SPORDER == "1") |>   
  mutate(
    ageCAT6 = as.factor(ageCAT6),
    RPA = as.factor(rpa_acr),
    HHtype = as.factor(HHtype)
  ) |>  
  group_by(
    RPA,
    ageCAT6
  ) |>  
  dplyr::count(
    var = HHtype,
    wt = WGTP
  ) |> 
  ungroup() |>  
  dplyr::rename(
    HHtype = var,
    BASELINE = n,
    AgeCat = ageCAT6
  ) |> 
  mutate(
    HHtype = case_when(
      HHtype == 1 ~ "hhderchild",
      HHtype == 2 ~ "nothhderchild",
      HHtype == 3 ~ "hhdernochild",
      HHtype == 4 ~ "nothhdernochild",
      HHtype == 5 ~ "single"
    ),
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
    ),
    INTER = BASELINE
  ) |> 
  dplyr::filter(HHtype == "hhderchild" | HHtype == "hhdernochild" | HHtype == "single") |>  
  mutate(
    HHtype = case_when(
      HHtype == "hhderchild" ~ "x == 1",
      HHtype == "hhdernochild" ~ "x == 3",
      HHtype == "single" ~ "x == 5"
    )
  )

# x.1.3 - Baseline of People in the laborforce
lf_baseline <- pums_data |>  
  filter(TYPEHUGQ == "1" & lf == "1") |>   
  mutate(
    ageCAT6 = as.factor(ageCAT6),
    RPA = as.factor(rpa_acr),
    eduattn = as.factor(eduattn)
  ) |>  
  group_by(
    RPA,
    ageCAT6
  ) |>  
  dplyr::count(
    var = eduattn,
    wt = PWGTP
  ) |>  
  ungroup() |>  
  rename(
    eduattn = var,
    BASELINE = n,
    AgeCat = ageCAT6
  ) |> 
  mutate(
    eduattn = case_when(
      eduattn == 1 ~ "High School or less",
      eduattn == 2 ~ "Some college or Associate's degree",
      eduattn == 3 ~ "Bachelor's",
      eduattn == 4 ~ "Master's or higher"
    ),
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
    )
  ) |>  
  mutate(
    eduattn = case_when(
      eduattn == "High School or less" ~ "x == 1",
      eduattn == "Some college or Associate's degree" ~ "x == 2",
      eduattn == "Bachelor's" ~ "x == 3",
      eduattn == "Master's or higher" ~ "x == 4"
    ),
    INTER = BASELINE
  )

#Output the baseline file for Household Population aggregations
write.csv(
  hhpop_baseline,
  paste0(output_path,"hhpop_baseline.1721.csv"), 
  row.names = FALSE
)

#Output the baseline file for Household Type aggregations
write.csv(
  hhtype_baseline,
  paste0(output_path,"hhtype_baseline.1721.csv"),
  row.names = FALSE
)

#Output the baseline file for Laborforce aggregations
write.csv(
  lf_baseline,
  paste0(output_path,"lf_baseline.1721.csv"),
  row.names = FALSE
)

```

# Create Headship rates for ACS 2017-2021 PUMS

```{r}
#Generating headship rates by RPA and 5-year age group for the ACS 2017-2022 PUMS
headship_rates <- pums_data |> 
  #Inclues only observations for people in households (omits GQ)                       
  filter(TYPEHUGQ == "1") |> 
  #Groups by variables in the dataframe necessary to getting the granularity of
  #data we're interested in.
  group_by(rpa_acr, ageCAT6) |> 
  #Computes the weighted sum of individuals in each HH type category by the groups
  #assigned above.
  count(var = HHtype, wt = WGTP) |>
  #Recodes factor variables as the categories they represent.
  #Converts numbers into frequencies.                       
  mutate(
    var = case_when(
      var == 1 ~ "hhderchild",
      var == 2 ~ "nothhderchild",
      var == 3 ~ "hhdernochild",
      var == 4 ~ "nothhdernochild",
      var == 5 ~ "single"),
    freq = (n/sum(n))) |> 
  #Removes the level of aggregation set earlier by group_by()
  ungroup() |> 
  select(
    -c(n)
  )

#QC Check - determine if the frequencies in each RP, Age Group crosstab add to 1
hr_check <- headship_rates |> 
  group_by(
    rpa_acr,
    ageCAT6
  ) |> 
  summarise(
    freq_check = sum(freq)
  ) |> 
  ungroup() |> 
  mutate(
    flag = ifelse(freq_check != 1, 1, 0)
  )

if (sum(hr_check$flag) > 0){
  print("STOP! Check headship rate calculations!")
} else{
  print("Proceed!")
}

#Write an intermediate file for the headship rates for the 17-21 PUMS
write.csv(
  headship_rates,
  paste0(output_path, "headship_rates.1721.csv"),
  row.names = FALSE
)

#Remove QC check dataframe
rm(hr_check)

#TODO:
# 1. Compare to 2015-2019 ACS PUMS Headship rates
# 2. Compare to adjusted headships rates from last projections

```

# Create Laborforce Participation rates for ACS 2017-2021 PUMS
```{r}
lfpr <- pums_data |> 
  #Takes only observations that are in housing units and in the labor force.
  filter(TYPEHUGQ == "1" & lf >= 1) |> 
  #Sets the level of aggregation (e.g. we want the number of observations by year, by RPA, by age group, by sex, by educational attainment) 
  group_by(rpa_acr, ageCAT6, eduattn, SEX) |> 
  #Sums up the number of observations by the level of aggregation set above using the person weight.
  count(var = lf, wt = PWGTP) |> 
  #Removes the level of aggregation set earlier by group_by()
  ungroup() |> 
  #Recodes factor variables as the categories they represent.
  #Converts numbers into frequencies.
  mutate(
    var = case_when(
      var == 1 ~ "in LF",
      var == 2 ~ "not in LF"),
    SEX = case_when(
      SEX == 1 ~ "Male",
      SEX == 2 ~ "Female"),
    EDUATTN = case_when(
      eduattn == 1 ~ "High School or less",
      eduattn == 2 ~ "Some college or Associate's degree",
      eduattn == 3 ~ "Bachelor's",
      eduattn == 4 ~ "Master's or higher")
  ) |> 
  group_by(rpa_acr, ageCAT6, SEX, EDUATTN) |>  
  #Converts numbers into frequencies for those in and not in the laborforce, based
  #on the demographic variables.
  mutate(
    freq = (n/sum(n))
  ) |>  
  ungroup() |> 
  filter(var == "in LF") |> 
  #Drops the "n" variable 
  select(-n)

#TODO:
# 1. Compare to 2015-2019 ACS PUMS headship rates
# 2. Compare to CPS rates
# 3. Do a similar lfpr adjustment exercise we did last time to the 2015-2019 lfpr

```

# Create Household Projections by RPA and Household Type
# 1. For MAPC101
# 2. For MAPC97

```{r}
#===============================================================================
# x.1.1 - Household Projections by RPA (MAPC101) and Household Type
proj.hh.MAPC101_by.rpa.hhtype <- left_join(
  umdi.pop.MAPC101,
  headship_rates,
  by = c("rpa_acr", "ageCAT6")
) |> 
  rowwise() |> 
  #Calculating the number of households in each RPA and age catergory
  mutate(
    hh = round(hhpop*freq, 0),
  ) |> 
  # Filter the headships rates foe the three household type categories
  # 1. hhderchild = households with a child under 18
  # 3. hhdernochild = Multiple adult, no children households
  # 5. single = Single householder
  filter(
    var == "hhderchild" | var == "hhdernochild" | var == "single"
  ) |> 
  mutate(
    HHtype = case_when(
      var == "hhderchild" ~ "x == 1",
      var == "hhdernochild" ~ "x == 3",
      var == "single" ~ "x == 5"
    ),
    AgeCat = case_when(
      ageCAT6 == 1 ~ "x == 1",
      ageCAT6 == 2 ~ "x == 2",
      ageCAT6 == 3 ~ "x == 3",
      ageCAT6 == 4 ~ "x == 4",
      ageCAT6 == 5 ~ "x == 5",
      ageCAT6 == 6 ~ "x == 6",
      ageCAT6 == 7 ~ "x == 7",
      ageCAT6 == 8 ~ "x == 8",
      ageCAT6 == 9 ~ "x == 9",
      ageCAT6 == 10 ~ "x == 10",
      ageCAT6 == 11 ~ "x == 11",
      ageCAT6 == 12 ~ "x == 12",
      ageCAT6 == 13 ~ "x == 13",
      ageCAT6 == 14 ~ "x == 14",
      ageCAT6 == 15 ~ "x == 15",
      ageCAT6 == 16 ~ "x == 16",
      ageCAT6 == 17 ~ "x == 17",
      ageCAT6 == 18 ~ "x == 18"
    )
  ) |> 
  select(-c(pop, hhpop, freq, var, ageCAT6)) |> 
  relocate(rpa_acr, AgeCat, HHtype, hh, year)
  

#===============================================================================
# x.1.2 Household Projections by MPO (MAPC97) and Household Type
proj.hh.MAPC97_by.mpo.hhtype <- left_join(
  umdi.pop.MAPC97,
  headship_rates,
  by = c("mpo" = "rpa_acr", "ageCAT6")
) |> 
  rowwise() |> 
  #Calculating the number of households in each RPA and age catergory
  mutate(
    hh = round(hhpop*freq, 0)
  )  |> 
  # Filter the headships rates foe the three household type categories
  # 1. hhderchild = households with a child under 18
  # 3. hhdernochild = Multiple adult, no children households
  # 5. single = Single householder
  filter(
    var == "hhderchild" | var == "hhdernochild" | var == "single"
  ) |> 
  mutate(
    HHtype = case_when(
      var == "hhderchild" ~ "x == 1",
      var == "hhdernochild" ~ "x == 3",
      var == "single" ~ "x == 5"
    ),
    AgeCat = case_when(
      ageCAT6 == 1 ~ "x == 1",
      ageCAT6 == 2 ~ "x == 2",
      ageCAT6 == 3 ~ "x == 3",
      ageCAT6 == 4 ~ "x == 4",
      ageCAT6 == 5 ~ "x == 5",
      ageCAT6 == 6 ~ "x == 6",
      ageCAT6 == 7 ~ "x == 7",
      ageCAT6 == 8 ~ "x == 8",
      ageCAT6 == 9 ~ "x == 9",
      ageCAT6 == 10 ~ "x == 10",
      ageCAT6 == 11 ~ "x == 11",
      ageCAT6 == 12 ~ "x == 12",
      ageCAT6 == 13 ~ "x == 13",
      ageCAT6 == 14 ~ "x == 14",
      ageCAT6 == 15 ~ "x == 15",
      ageCAT6 == 16 ~ "x == 16",
      ageCAT6 == 17 ~ "x == 17",
      ageCAT6 == 18 ~ "x == 18"
    )
  ) |> 
  select(-c(pop, hhpop, freq, var, ageCAT6)) |> 
  relocate(mpo, AgeCat, HHtype, hh, year)

```

# Create Reweighter Template Files for Household Projections by RPA/MPO and Household Type

```{r}
years <- c(2010, 2020, 2030, 2040, 2050)

# MAPC101/RPA Versions
for (i in years) {
  tmp <- proj.hh.MAPC101_by.rpa.hhtype |> 
    filter(
      year == i
    )
}

```

```{r}
################################################################################
# 5. Generate BASELINE data for the reweighter targeting files
#
#5.1.1 Labor Force Participation by Sex, Age, Educational Attainment
PUMS_LF_PAGEC_SEX_EDUATTN_RPA <- PUMS_data %>%
  #Takes only observations that are in housing units and in the labor force.
  filter(TYPE == 1 & lf >= 1) %>%
  #Sets the level of aggregation (e.g. we want the number of observations by year, by RPA, by age group, by sex, by educational attainment) 
  group_by(year, RPA, PAGEC, eduattn, SEX) %>%
  #Sums up the number of observations by the level of aggregation set above using the person weight.
  count(var = lf, wt = PWGTP) %>%
  #Removes the level of aggregation set earlier by group_by()
  ungroup() %>%
  #Recodes factor variables as the categories they represent.
  #Converts numbers into frequencies.
  mutate(
    var = case_when(
      var == 1 ~ "in LF",
      var == 2 ~ "not in LF"),
    SEX = case_when(
      SEX == 1 ~ "Male",
      SEX == 2 ~ "Female"),
    EDUATTN = case_when(
      eduattn == 1 ~ "High School or less",
      eduattn == 2 ~ "Some college or Associate's degree",
      eduattn == 3 ~ "Bachelor's",
      eduattn == 4 ~ "Master's or higher")
  ) %>%
  group_by(
    year, RPA, PAGEC, SEX, EDUATTN
  ) %>% 
  #Converts numbers into frequencies for those in and not in the laborforce, based
  #on the demographic variables.
  mutate(
    freq = (n/sum(n))
  ) %>% 
  ungroup() %>% 
  filter(var == "in LF" & year == 2019) %>%
  #Drops the "n" variable 
  select(-n) #%>%
  #Rearranges the dataframe to have each column be a level of labor force participation.
  #and each row be an age sex, and educational attainment group.
  #pivot_wider(names_from = var, values_from = freq)
  #pivot_wider(names_from = var, values_from = n)

#Bring in Labor Force Participation Rate Adjustment 
lfpr_adj <- read_excel(
  paste0(HH_Pop_Proj_dir,"LFPR_adjustment.xlsx"),
  sheet = 1
  ) %>%
  mutate(
    age_cat = as.factor(age_cat)
  )

#Join adjustment to PUMS laborforce participation rate calculations
PUMS_LF_PAGEC_SEX_EDUATTN_RPA <- left_join(PUMS_LF_PAGEC_SEX_EDUATTN_RPA, lfpr_adj, by = c("PAGEC" = "age_cat", "SEX" = "sex"))

PUMS_LF_PAGEC_SEX_EDUATTN_RPA <- PUMS_LF_PAGEC_SEX_EDUATTN_RPA %>%
  mutate(static_rate = freq,
         LFPR_adj_2020 = freq+adj_2020,
         LFPR_adj_2020 = if_else(LFPR_adj_2020 < 0, 0, LFPR_adj_2020),
         LFPR_adj_2020 = if_else(LFPR_adj_2020 > 1.0, 1.0, LFPR_adj_2020),
         LFPR_adj_2030_2050 = LFPR_adj_2020+adj_2030_2050,
         LFPR_adj_2030_2050 = if_else(LFPR_adj_2030_2050 < 0, 0, LFPR_adj_2030_2050),
         LFPR_adj_2030_2050 = if_else(LFPR_adj_2030_2050 > 1.0, 1.0, LFPR_adj_2030_2050)) %>%
  select(RPA, PAGEC, SEX, EDUATTN, static_rate, LFPR_adj_2020, LFPR_adj_2030_2050)

lfpr_2000 <- PUMS_LF_PAGEC_SEX_EDUATTN_RPA %>% 
  select(
    RPA, PAGEC, SEX, EDUATTN, static_rate
  ) %>% 
  dplyr::rename(
    lfpr = static_rate
  ) %>% 
  mutate(
    Year = 2000
  )

lfpr_2010 <- PUMS_LF_PAGEC_SEX_EDUATTN_RPA %>% 
  select(
    RPA, PAGEC, SEX, EDUATTN, static_rate
  )  %>% 
  dplyr::rename(
    lfpr = static_rate
  ) %>%  
  mutate(
    Year = 2010
  )

lfpr_2020 <- PUMS_LF_PAGEC_SEX_EDUATTN_RPA %>% 
  select(
    RPA, PAGEC, SEX, EDUATTN, LFPR_adj_2020
  ) %>% 
  dplyr::rename(
    lfpr = LFPR_adj_2020
  ) %>% 
  mutate(
    Year = 2020
  )

lfpr_2030 <- PUMS_LF_PAGEC_SEX_EDUATTN_RPA %>% 
  select(
    RPA, PAGEC, SEX, EDUATTN, LFPR_adj_2030_2050
  ) %>% 
  dplyr::rename(
    lfpr = LFPR_adj_2030_2050
  ) %>%  
  mutate(
    Year = 2030
  )

lfpr_2040 <- PUMS_LF_PAGEC_SEX_EDUATTN_RPA %>% 
  select(
    RPA, PAGEC, SEX, EDUATTN, LFPR_adj_2030_2050
  ) %>% 
  dplyr::rename(
    lfpr = LFPR_adj_2030_2050
  ) %>% 
  mutate(
    Year = 2040
  )

lfpr_2050 <- PUMS_LF_PAGEC_SEX_EDUATTN_RPA %>% 
  select(
    RPA, PAGEC, SEX, EDUATTN, LFPR_adj_2030_2050
  ) %>% 
  dplyr::rename(
    lfpr = LFPR_adj_2030_2050
  ) %>%  
  mutate(
    Year = 2050
  )

lfpr <- bind_rows(lfpr_2000,lfpr_2010,lfpr_2020,lfpr_2030,lfpr_2040,lfpr_2050) %>% mutate(Year = as.character(Year))

#Determine how many people are in each educational attainment bracket
umdi_pop_educ <- left_join(umdi_hh_population_proj, PUMS_pop_by_educ, by = c("MPO" = "RPA", "Sex"  = "SEX", "Age.Group" = "PAGEC"))

umdi_pop_educ <- umdi_pop_educ %>% 
  filter(
    Age.Group != 1 & Age.Group != 2 & Age.Group != 3
  ) %>% 
  mutate(
    HH_Population_Educ = HH_Population*freq
  ) %>% 
  select(
    -c(
      HH_Population,
      year,
      freq
    )
  ) %>% 
  dplyr::rename(
    EDUATTN = var
  ) %>% 
  relocate(
    EDUATTN,
    .before = HH_Population_Educ
  )

# Now Join the laborforce participation rate to the household population number by 
umdi_pop_educ_lf <- left_join(umdi_pop_educ, lfpr, by = c("Year", "MPO" = "RPA", "Sex"  = "SEX", "Age.Group" = "PAGEC", "EDUATTN"))

umdi_pop_educ_lf_cleaned <- umdi_pop_educ_lf %>% 
  mutate(
    lf = HH_Population_Educ*lfpr
  ) %>%
  select(
    -c(
      HH_Population_Educ,
      lfpr
    )
  ) %>% 
  pivot_wider(
    names_from = Year,
    values_from = lf
  ) %>% 
  dplyr::rename(
    lf_2000 = `2000`,
    lf_2010 = `2010`,
    lf_2020 = `2020`,
    lf_2030 = `2030`,
    lf_2040 = `2040`,
    lf_2050 = `2050`
  )

write.csv(umdi_pop_educ_lf_cleaned, "K:/DataServices/Projects/Current_Projects/Projections/Data/Tabular/tProjections 2022 v2050/Outputs/lf_age_sex_educ_cleaned_v3.22.23.csv",
          row.names = FALSE)

#5.2 Household Type by Age

#RPA LEVEL
PUMS_HHtype_PAGEC_RPA <- PUMS_data %>%
  #Inclues only observations for people in households (omits GQ)                       
  filter(TYPE == 1) %>%
  #Groups by variables in the dataframe necessary to getting the granularity of
  #data we're interested in.
  group_by(year, RPA, PAGEC) %>%
  #Computes the weighted sum of individuals in each HH type category by the groups
  #assigned above.
  count(var = HHtype, wt = PWGTP) %>%
  #Recodes factor variables as the categories they represent.
  #Converts numbers into frequencies.                       
  mutate(
    var = case_when(
      var == 1 ~ "hhderchild",
      var == 2 ~ "nothhderchild",
      var == 3 ~ "hhdernochild",
      var == 4 ~ "nothhdernochild",
      var == 5 ~ "single"),
    freq = (n/sum(n))) %>%
  #Selects the appropriate year of data
  filter(year == 2019) %>%
  #Removes the level of aggregation set earlier by group_by()
  ungroup()# %>%
  #Drops the variable that represents the number of observations from each category
  #select(-n) #%>%
  #Pivots the dataframe to a wide format 
  #pivot_wider(names_from = var, values_from = freq)
  #pivot_wider(names_from = var, values_from = freq)

#write.csv(PUMS_HHtype_PAGEC_RPA,
          #"S:/Network Shares/NEW K Drive/DataServices/Projects/Current_Projects/Projections/Data/Tabular/tProjections 2022 v2050/Outputs/hhtype_rates_v1.csv")
write.csv(PUMS_HHtype_PAGEC_RPA,
          "K:/DataServices/Projects/Current_Projects/Projections/Reweighter/Alternative_Scenarios/MAPC_General_HHd_Target/Projected_HeadshipRate_Adjustements/ACSPUMS_15_19_hhtype_rates_v03.22.23.csv",
          row.names = FALSE)
PUMS_HHtype_PAGEC_RPA <- read.csv(
  "K:/DataServices/Projects/Current_Projects/Projections/Reweighter/Alternative_Scenarios/MAPC_General_HHd_Target/Projected_HeadshipRate_Adjustements/ACSPUMS_15_19_hhtype_rates_v03.22.23_ADJUSTED.csv"
) %>% 
  select(
    -c(
      freq,
      adjustment,
      Ignore
    )
  ) %>% 
  dplyr::rename(
    freq = freq_adj
  )


umdi_hh_population_projs_age <- umdi_hh_population_proj %>%
  group_by(Year, MPO, Age.Group) %>%
  summarise(
    HH_Population = sum(HH_Population)
  ) %>% 
  ungroup()

umdi_pop_hhtype_age <- left_join(umdi_hh_population_projs_age, PUMS_HHtype_PAGEC_RPA, by = c("MPO" = "RPA", "Age.Group" = "PAGEC"))

umdi_pop_hhtype_age_cleaned <- umdi_pop_hhtype_age %>% 
  dplyr::rename(
    HH_type = var
  ) %>%
  rowwise() %>% 
  mutate(
    Households = HH_Population*freq
  ) %>% 
  select(
    -c(
      year,
      freq,
      HH_Population
    )
  ) %>% 
  pivot_wider(
    names_from = Year,
    values_from = Households
  ) %>% 
  dplyr::rename(
    proj_hh_2000 = `2000`,
    proj_hh_2010 = `2010`,
    proj_hh_2020 = `2020`,
    proj_hh_2030 = `2030`,
    proj_hh_2040 = `2040`,
    proj_hh_2050 = `2050`
  )


write.csv(umdi_pop_hhtype_age_cleaned,
          "K:/DataServices/Projects/Current_Projects/Projections/Data/Tabular/tProjections 2022 v2050/Outputs/hhtype_age_PROJECTIONS_v03.22.23.csv",
          row.names = FALSE)

```

# Part 5

```{r}
### Format Targets for Reweighter from Projections
### Author: Brandon Stanaway
### Date: 08/05/2022
### Purpose:Takes output from projections methodology to create target files for the reweighter
### Same purpose as excel file K:/DataServices/Projects/Current_Projects/LandUseAllocationModel/Data/Analysis/UrbanSim_Inputs/HH_Targets/Reweighter_Targets_091020/Format_V2Projections_forControls.xlsx
### Targets are AgeHHder_HHtype, Pop_Age, Age_Edu_LF

rm(list=ls())
#install.packages("pacman")
pacman::p_load(tidyverse, plyr, dplyr,data.table, magrittr, readxl)

options(scipen = 999)

###Set directory paths for working remotely or in the office
#Remote
#inpath <- 'S:/Network Shares/DS Projects/Current_Projects/Projections/Data/Tabular/tProjections 2022 v2050/Outputs/'

#In-office
inpath <- 'K:/DataServices/Projects/Current_Projects/Projections/Data/Tabular/tProjections 2022 v2050/Outputs/'

#Remote
#outpath <- 'S:/Network Shares/DS Projects/Current_Projects/Projections/Data/Tabular/tProjections 2022 v2050/Outputs/'

#In-office
outpath <- 'K:/DataServices/Projects/Current_Projects/Projections/Data/Tabular/tProjections 2022 v2050/Outputs/'

#Remote
#reweighter_path <- 'S:/Network Shares/DS Projects/Current_Projects/Projections/Reweighter/Input Files/'

#In-office
reweighter_path <- 'K:/DataServices/Projects/Current_Projects/Projections/Reweighter/Input_Files/'

#Read in baseline files created in the "Projections 2050 Mastercode" R script
temp_hhd_proj <- fread(paste0(inpath,'hhtype_baseline.csv'))
temp_lf_proj <-  fread(paste0(inpath,'lf_baseline.csv'))
temp_pop_proj <-  fread(paste0(inpath,'hhpop_baseline.csv'))

#Depricated?
#temp_hhd_proj[HHtype=='x == 1', HHtype:='x == 5']
#temp_hhd_proj[HHtype=='x == 3', HHtype:='x == 1']
#temp_hhd_proj[HHtype=='x == 2', HHtype:='x == 3']


###HHd Projections####
hhd_proj <- read.csv(paste0(outpath,'hhtype_age_PROJECTIONS_v03.22.23.csv'))

hhd_proj %<>%
  filter(
    HH_type != "nothhderchild" & HH_type != "nothhdernochild"
  ) %>% 
  replace(
    is.na(.), 0
  ) %>% 
  dplyr::rename(
    RPA = MPO,
    AgeCat = Age.Group
  ) %>% 
  mutate(
    HH_type = case_when(
      HH_type == "hhderchild" ~ "x == 1",
      HH_type == "hhdernochild" ~ "x == 3",
      HH_type == "single" ~ "x == 5",
    ),
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
    )
  )

temp_hhd_proj %<>%
  mutate(
    INTER = BASELINE
  ) %>% 
  select(
    RPA,
    AgeCat,
    HHtype,
    BASELINE,
    INTER
  )

hhd_proj_all <- left_join(hhd_proj, temp_hhd_proj, by = c("RPA", "AgeCat", "HH_type" = "HHtype"))

hhd_proj_all %<>%
  dplyr::rename(
    ageCAT3 = AgeCat
  ) %>% 
  replace(
    is.na(.), 0
  )

V2_hhd_2010f <- hhd_proj_all %>% 
  select(
   RPA,
   ageCAT3,
   HH_type,
   proj_hh_2010,
   BASELINE,
   INTER
  ) %>% 
  dplyr::rename(
    HHtype = HH_type,
    TARGET = proj_hh_2010
  )

write.csv(V2_hhd_2010f,
          paste0(reweighter_path, "AgeHHder_HHtype_2010_V03.22.23.csv"),
          row.names = FALSE)
  
V2_hhd_2020f <- hhd_proj_all %>% 
  select(
    RPA,
    ageCAT3,
    HH_type,
    proj_hh_2020,
    BASELINE,
    INTER
  ) %>% 
  dplyr::rename(
    HHtype = HH_type,
    TARGET = proj_hh_2020
  )

write.csv(V2_hhd_2020f,
          paste0(reweighter_path, "AgeHHder_HHtype_2020_V03.22.23.csv"),
          row.names = FALSE)

V2_hhd_2030f <- hhd_proj_all %>% 
  select(
    RPA,
    ageCAT3,
    HH_type,
    proj_hh_2030,
    BASELINE,
    INTER
  ) %>% 
  dplyr::rename(
    HHtype = HH_type,
    TARGET = proj_hh_2030
  )

write.csv(V2_hhd_2030f,
          paste0(reweighter_path, "AgeHHder_HHtype_2030_V03.22.23.csv"),
          row.names = FALSE)

V2_hhd_2040f <- hhd_proj_all %>% 
  select(
    RPA,
    ageCAT3,
    HH_type,
    proj_hh_2040,
    BASELINE,
    INTER
  ) %>% 
  dplyr::rename(
    HHtype = HH_type,
    TARGET = proj_hh_2040
  )

write.csv(V2_hhd_2040f,
          paste0(reweighter_path, "AgeHHder_HHtype_2040_V03.22.23.csv"),
          row.names = FALSE)

V2_hhd_2050f <- hhd_proj_all %>% 
  select(
    RPA,
    ageCAT3,
    HH_type,
    proj_hh_2050,
    BASELINE,
    INTER
  ) %>% 
  dplyr::rename(
    HHtype = HH_type,
    TARGET = proj_hh_2050
  )

write.csv(V2_hhd_2050f,
          paste0(reweighter_path, "AgeHHder_HHtype_2050_V03.22.23.csv"),
          row.names = FALSE)

####LF Projections####

setwd(outpath)
lf_projections <- read_excel('lf_age_educ_v1.xlsx',
                             sheet = 1)

lf_projections %<>%
  replace(
    is.na(.),
    0
  ) %>% 
  dplyr::rename(
    RPA = MPO,
    Year = PRED_YEAR,
    AgeCat = age_cat
  )

lf_proj1 <- lf_projections %>% 
  select(
    RPA,
    Year,
    AgeCat,
    `High School or less Male in LF`,
    `High School or less Female in LF`
  ) %>% 
  mutate(
    TARGET = `High School or less Male in LF` + `High School or less Female in LF`,
    edu = "x == 1",
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
    )
  ) %>% 
  select(
    -`High School or less Male in LF`,
    -`High School or less Female in LF`
  )

lf_proj2 <- lf_projections %>% 
  select(
    RPA,
    Year,
    AgeCat,
    `Some college or Associate's degree Male in LF`,
    `Some college or Associate's degree Female in LF`
  ) %>% 
  mutate(
    TARGET = `Some college or Associate's degree Male in LF` + `Some college or Associate's degree Female in LF`,
    edu = "x == 2",
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
    )
  ) %>% 
  select(
    -`Some college or Associate's degree Male in LF`,
    -`Some college or Associate's degree Female in LF`
  )

lf_proj3 <- lf_projections %>% 
  select(
    RPA,
    Year,
    AgeCat,
    `Bachelor's Male in LF`,
    `Bachelor's Female in LF`
  ) %>% 
  mutate(
    TARGET = `Bachelor's Male in LF` + `Bachelor's Female in LF`,
    edu = "x == 3",
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
    )
  ) %>% 
  select(
    -`Bachelor's Male in LF`,
    -`Bachelor's Female in LF`
  )


lf_proj4 <- lf_projections %>% 
  select(
    RPA,
    Year,
    AgeCat,
    `Master's or higher Male in LF`,
    `Master's or higher Female in LF`
  ) %>% 
  mutate(
    TARGET = `Master's or higher Male in LF` + `Master's or higher Female in LF`,
    edu = "x == 4",
    AgeCat = case_when(
      AgeCat == 1 ~ "x == 1",
      AgeCat == 2 ~ "x == 2",
      AgeCat == 3 ~ "x == 3",
      AgeCat == 4 ~ "x == 4",
      AgeCat == 5 ~ "x == 5",
      AgeCat == 6 ~ "x == 6",
      AgeCat == 7 ~ "x == 7",
      AgeCat == 8 ~ "x == 8",
      AgeCat == 9 ~ "x == 9",
      AgeCat == 10 ~ "x == 10",
      AgeCat == 11 ~ "x == 11",
      AgeCat == 12 ~ "x == 12",
      AgeCat == 13 ~ "x == 13",
      AgeCat == 14 ~ "x == 14",
      AgeCat == 15 ~ "x == 15",
      AgeCat == 16 ~ "x == 16",
      AgeCat == 17 ~ "x == 17",
      AgeCat == 18 ~ "x == 18"
    )
  ) %>% 
  select(
    -`Master's or higher Male in LF`,
    -`Master's or higher Female in LF`
  )

lf_proj <- rbind(lf_proj1, lf_proj2, lf_proj3, lf_proj4)

lf_proj %<>%
  dplyr::rename(
    ageCAT3 = AgeCat
  )

temp_lf_proj %<>%
  mutate(
    INTER = BASELINE,
    lf = "x == 1"
  ) %>%
  dplyr::rename(
    edu = eduattn
  ) %>% 
  select(
    RPA,
    AgeCat,
    edu,
    BASELINE,
    INTER,
    lf
  )

lf_proj_all <- left_join(lf_proj, temp_lf_proj, by = c("RPA", "ageCAT3" = "AgeCat", "edu"))

V2_lf_2010f <- lf_proj_all %>% 
  filter(
    Year == 2010
  ) %>% 
  select(
    RPA,
    ageCAT3,
    edu,
    lf,
    BASELINE,
    TARGET
  )

write.csv(V2_lf_2010f,
          "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/LF_Age_Edu_2010_V2.csv",
          row.names = FALSE
)

V2_lf_2020f <- lf_proj_all %>% 
  filter(
    Year == 2020
  ) %>% 
  select(
    RPA,
    ageCAT3,
    edu,
    lf,
    BASELINE,
    TARGET
  )

write.csv(V2_lf_2020f,
          "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/LF_Age_Edu_2020_V2.csv",
          row.names = FALSE
)

V2_lf_2030f <- lf_proj_all %>% 
  filter(
    Year == 2030
  ) %>% 
  select(
    RPA,
    ageCAT3,
    edu,
    lf,
    BASELINE,
    TARGET
  )

write.csv(V2_lf_2030f,
          "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/LF_Age_Edu_2030_V2.csv",
          row.names = FALSE
)

V2_lf_2040f <- lf_proj_all %>% 
  filter(
    Year == 2040
  ) %>% 
  select(
    RPA,
    ageCAT3,
    edu,
    lf,
    BASELINE,
    TARGET
  )

write.csv(V2_lf_2040f,
          "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/LF_Age_Edu_2040_V2.csv",
          row.names = FALSE
)

V2_lf_2050f <- lf_proj_all %>% 
  filter(
    Year == 2050
  ) %>% 
  select(
    RPA,
    ageCAT3,
    edu,
    lf,
    BASELINE,
    TARGET
  )

write.csv(V2_lf_2050f,
          "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/LF_Age_Edu_2050_V2.csv",
          row.names = FALSE
  )

####PopbyAge####
####V2####
setwd(outpath)
data <-read_excel('hhpop_age_v1.xlsx',
                  sheet = 1)

data %<>% 
  dplyr::rename(
    AgeCat = age_cat
  ) %>% 
  mutate(
  AgeCat = case_when(
    AgeCat == 1 ~ "x == 1",
    AgeCat == 2 ~ "x == 2",
    AgeCat == 3 ~ "x == 3",
    AgeCat == 4 ~ "x == 4",
    AgeCat == 5 ~ "x == 5",
    AgeCat == 6 ~ "x == 6",
    AgeCat == 7 ~ "x == 7",
    AgeCat == 8 ~ "x == 8",
    AgeCat == 9 ~ "x == 9",
    AgeCat == 10 ~ "x == 10",
    AgeCat == 11 ~ "x == 11",
    AgeCat == 12 ~ "x == 12",
    AgeCat == 13 ~ "x == 13",
    AgeCat == 14 ~ "x == 14",
    AgeCat == 15 ~ "x == 15",
    AgeCat == 16 ~ "x == 16",
    AgeCat == 17 ~ "x == 17",
    AgeCat == 18 ~ "x == 18"
  )
)

pop_proj_all <- left_join(data, temp_pop_proj, by = c("MPO" = "RPA", "AgeCat"))

pop_proj_all %<>%
  dplyr::rename(
    RPA = MPO,
    ageCAT3 = AgeCat,
    TARGET = proj_hh_pop,
    Year = year
  )
  
V2_hhpop_2020f <- pop_proj_all %>% 
  filter(
    Year == 2020
  ) %>% 
  select(
    RPA,
    ageCAT3,
    TARGET,
    BASELINE
  )

write.csv(
  V2_hhpop_2020f,
  "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/Pop_Age_2020_V2.csv",
  row.names = FALSE
)

V2_hhpop_2030f <- pop_proj_all %>% 
  filter(
    Year == 2030
  ) %>% 
  select(
    RPA,
    ageCAT3,
    TARGET,
    BASELINE
  )

write.csv(
  V2_hhpop_2030f,
  "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/Pop_Age_2030_V2.csv",
  row.names = FALSE
)

V2_hhpop_2040f <- pop_proj_all %>% 
  filter(
    Year == 2040
  ) %>% 
  select(
    RPA,
    ageCAT3,
    TARGET,
    BASELINE
  )

write.csv(
  V2_hhpop_2040f,
  "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/Pop_Age_2040_V2.csv",
  row.names = FALSE
)

V2_hhpop_2050f <- pop_proj_all %>% 
  filter(
    Year == 2050
  ) %>% 
  select(
    RPA,
    ageCAT3,
    TARGET,
    BASELINE
  )

write.csv(
  V2_hhpop_2050f,
  "//data-001/public/DataServices/Projects/Current_Projects/Projections/Reweighter/Input Files/Pop_Age_2050_V2.csv",
  row.names = FALSE
)

```
